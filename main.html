<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eatsence.ai: AI Nutrition Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #D4AF37;
            --deep-navy: #0A0E17;
            --rich-burgundy: #722F37;
            --soft-ivory: #F5F5F0;
            --dark-charcoal: #1A1A1A;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--deep-navy) 0%, #0D131F 100%);
            color: var(--soft-ivory);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .luxury-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .luxury-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.3);
        }

        /* Logo Watermark Styling */
        .logo-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            opacity: 0.03;
            pointer-events: none;
            z-index: 0;
            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAH0AfQDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRB1ESExIhY3GUk5RRUgaGxwYmR0Vmd3eHh5jY5UYWJjZGhwaHl9e3uayrC3v7jIxczR0lJkpbXFyc3V1nd4eXqayrC3v7jIxczR0lJkpbXFyc3V1nd4eXqayv/EAB8BAQADAQEBAQEBAQEBAAAAAAAAAAECwMDQYJcQERIhMTL/8QAtBEAAgECAwQHBgYEBAEFAfEBAgMABBESITEFURVAgZEGMnGSkxVDUqLR0gIHFlbX2RnYwOEhgbHTZ3eHVXgIeMhkaLhzdnfr8P8QxM/8Q/9oADAMBAAIRAxEH/9k=');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .gold-accent {
            color: var(--primary-gold);
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, var(--primary-gold) 0%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .luxury-button {
            background: linear-gradient(135deg, var(--primary-gold) 0%, #B8860B 100%);
            color: var(--deep-navy);
            font-weight: 700;
            border-radius: 16px;
            padding: 14px 28px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .luxury-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.6s;
        }
        
        .luxury-button:hover::before {
            left: 100%;
        }
        
        .luxury-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
        }
        
        .luxury-sidebar {
            background: rgba(10, 14, 23, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }
            100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }
        }
        
        .sidebar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        
        .sidebar-arrow {
            transition: transform 0.3s ease-in-out;
        }
        
        .rotated {
            transform: rotate(90deg);
        }
        
        .macro-progress {
            height: 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .macro-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--progress-width, 0%);
            background: linear-gradient(90deg, var(--progress-color, #D4AF37), #FFD700);
            border-radius: 10px;
            transition: width 1s ease-in-out;
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--soft-ivory);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .glass-input:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        .food-log-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .food-log-item:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(212, 175, 55, 0.2);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(212, 175, 55, 0.5);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Adjust main content for fixed sidebar */
        @media (min-width: 640px) {
            #dashboard-container {
                margin-left: 16rem; /* ml-64 */
            }
        }

        /* Sidebar Toggle for Mobile */
        .sidebar-mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 39;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-mobile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #sidebar {
            transition: transform 0.3s ease;
        }

        #sidebar.mobile-hidden {
            transform: translateX(-100%);
        }

        #sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .luxury-modal {
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .mood-option {
            transition: all 0.3s ease;
            border-radius: 50%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .mood-option:hover {
            transform: scale(1.1);
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--primary-gold);
        }
        
        .mood-option.active {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--primary-gold);
            transform: scale(1.1);
        }
        
        .luxury-tag {
            background: rgba(212, 175, 55, 0.2);
            color: var(--primary-gold);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* NEW: Hidden input styling for camera button */
        .file-input-label {
            display: block;
            cursor: pointer;
            text-align: center;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--soft-ivory);
            font-weight: 500;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary-gold);
        }

        .file-input-label input {
            display: none;
        }

        /* NEW: Enhanced glass-input for better select/input visibility */
        .glass-input-enhanced {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--soft-ivory);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            -webkit-appearance: none; /* Remove default browser styling for select */
            appearance: none;
        }
        
        .glass-input-enhanced:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        /* NEW: Welcome Animation */
        .welcome-animation {
            animation: welcomeSlideIn 1.2s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }
        
        @keyframes welcomeSlideIn {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* NEW: Background Logo Watermark */
        .bg-logo-watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            opacity: 0.02;
            pointer-events: none;
            z-index: 0;
            background-image: url('eatsence logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- NEW: Background Logo Watermark -->
    <div class="bg-logo-watermark"></div>
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full bg-gradient-to-r from-yellow-900 to-transparent opacity-10 blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full bg-gradient-to-r from-amber-900 to-transparent opacity-10 blur-3xl"></div>
        <div class="absolute top-1/2 left-1/4 w-60 h-60 rounded-full bg-gradient-to-r from-amber-800 to-transparent opacity-5 blur-3xl"></div>
    </div>

    <div id="sidebar-overlay" class="sidebar-mobile-overlay sm:hidden" onclick="toggleSidebar()"></div>

    <nav id="sidebar" class="fixed top-0 left-0 h-full w-64 luxury-sidebar z-40 p-6 space-y-6 overflow-y-auto custom-scrollbar mobile-hidden sm:mobile-open">
        <div class="flex flex-col items-center justify-center mb-8 pt-4">
            <img src="eatsence logo.png" alt="eatsence.ai Logo" class="w-32 h-auto mb-2">
            <h2 class="text-2xl font-bold gold-gradient font-serif">EATSENCE<span class="text-amber-200/80 text-sm">.ai</span></h2>
        </div>

        <style>
            .sidebar-header {
                @apply w-full flex justify-between items-center text-base font-semibold text-white p-3 rounded-xl bg-gradient-to-r from-amber-900/30 to-transparent hover:from-amber-800/40 transition-all duration-300 cursor-pointer border border-amber-900/20 hover:border-amber-700/40;
            }
            .sidebar-sub-btn {
                @apply w-full text-left py-2 px-4 rounded-lg text-amber-100/80 hover:bg-amber-900/20 hover:text-amber-300 transition-all duration-300 text-sm font-medium border border-transparent hover:border-amber-800/30;
            }
        </style>
        
        <div>
            <button class="sidebar-header" data-target="mental-flow-content" onclick="toggleSection(this)">
                <span class="flex items-center">
                    <span class="mr-2">🧠</span> Mental Flow
                </span>
                <span class="sidebar-arrow transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </button>
            <div id="mental-flow-content" class="sidebar-content space-y-1 py-1 pl-2">
                <button onclick="startMeditation()" class="sidebar-sub-btn">Start Meditation</button>
                <button id="journal-open-btn" class="sidebar-sub-btn">Gratitude Journal</button>
                <button onclick="showAffirmation()" class="sidebar-sub-btn">Affirmation Generator</button>
                <button onclick="showSimpleMessage('Digital Detox', 'Reminder set: We\'ll alert you when it\'s time for your daily screen-free goal.', 'amber-400')" class="sidebar-sub-btn">Digital Detox Reminder</button>
            </div>
        </div>

        <div>
            <button class="sidebar-header" data-target="physical-flow-content" onclick="toggleSection(this)">
                <span class="flex items-center">
                    <span class="mr-2">💪</span> Physical Balance
                </span>
                <span class="sidebar-arrow transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </button>
            <div id="physical-flow-content" class="sidebar-content space-y-1 py-1 pl-2">
                <button onclick="planMeal()" class="sidebar-sub-btn">Plan My Meal (AI)</button>
                <button onclick="startWaterTracker()" id="water-tracker-btn" class="sidebar-sub-btn">Water Tracker: 0% (0 cups)</button>
                <button onclick="generateWorkout()" class="sidebar-sub-btn">Workout Routine Generator</button>
                <button onclick="postureAlert()" class="sidebar-sub-btn">Posture Alert Timer</button>
            </div>
        </div>

        <div>
            <button class="sidebar-header" data-target="emotional-flow-content" onclick="toggleSection(this)">
                <span class="flex items-center">
                    <span class="mr-2">❤️</span> Emotional Core
                </span>
                <span class="sidebar-arrow transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </button>
            <div id="emotional-flow-content" class="sidebar-content space-y-1 py-1 pl-2">
                <button onclick="startMoodMusic()" class="sidebar-sub-btn">Mood Music Player</button>
                <button id="mood-tracker-btn" class="sidebar-sub-btn">Mood Tracker</button>
                <button onclick="connectAndShare()" class="sidebar-sub-btn">Connect & Share (Positive)</button>
                <button onclick="showSimpleMessage('Nature Timer', 'Reminder set: Take 20 minutes outside today for fresh air.', 'green-400')" class="sidebar-sub-btn">Nature Timer</button>
            </div>
        </div>

        <div>
            <button class="sidebar-header" data-target="daily-flow-content" onclick="toggleSection(this)">
                <span class="flex items-center">
                    <span class="mr-2">🌙</span> Daily System & Goals
                </span>
                <span class="sidebar-arrow transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </button>
            <div id="daily-flow-content" class="sidebar-content space-y-1 py-1 pl-2">
                <button onclick="scheduleDay()" class="sidebar-sub-btn">Schedule My Day</button>
                <button onclick="showReminders()" class="sidebar-sub-btn">Health Reminders</button>
                <button onclick="runChallenge()" class="sidebar-sub-btn">Run 2-Day Challenge</button>
                <button onclick="showSimpleMessage('Progress Tracker', 'View hydration, sleep, and mood trends (Future Feature).', 'gray-400')" class="sidebar-sub-btn">Progress Tracker</button>
            </div>
        </div>
        
        <div class="pt-8 border-t border-amber-900/30 mt-8">
            <div class="text-center text-amber-200/60 text-xs">
                <p>eatsence.ai Premium</p>
                <p class="mt-1">Health & Wellness</p>
            </div>
        </div>
    </nav>

    <div id="dashboard-container" class="flex-1 p-4 sm:p-8 max-w-4xl mx-auto sm:ml-64 relative z-10">
        <header class="mb-8 flex justify-between items-center pb-6">
            <div class="flex items-center space-x-4">
                 <button id="mobile-sidebar-toggle" class="sm:hidden p-2 rounded-lg text-amber-300 hover:bg-amber-900/30 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                     </svg>
                 </button>
                 <div>
                     <!-- NEW: Added username display -->
                     <h1 class="text-4xl font-bold font-serif gold-gradient mb-2">Welcome, <span id="username-display">Alex</span>!</h1>
                     <p class="text-amber-200/70 text-sm">AI-Powered Nutrition & Wellness Tracking</p>
                 </div>
            </div>
            <div class="flex items-center space-x-4">
                <p id="dashboard-date" class="text-amber-200/60 text-sm font-medium"></p>
                <button id="goals-button" class="luxury-button text-sm">Set Goals</button>
            </div>
        </header>
        
        <!-- NEW: Added welcome-animation class -->
        <div id="summary-card" class="mb-8 luxury-card p-6 floating-element welcome-animation" style="animation-delay: 0.1s">
            <div class="logo-watermark"></div> <div class="flex justify-between items-start mb-4 relative z-10">
                <h2 class="text-xl font-bold gold-accent">Today's Nutrition Budget</h2>
                <span class="luxury-tag">Daily Target</span>
            </div>
            <div class="grid grid-cols-2 gap-6 relative z-10">
                <div class="text-center p-4 rounded-2xl bg-gradient-to-br from-amber-900/20 to-transparent border border-amber-800/30">
                    <p class="text-sm text-amber-200/70 mb-1">Target Calories</p>
                    <p id="summary-target" class="text-3xl font-extrabold text-white">2200 <span class="text-base text-amber-200/60">kcal</span></p>
                </div>
                <div class="text-center p-4 rounded-2xl bg-gradient-to-br from-cyan-900/20 to-transparent border border-cyan-800/30">
                    <p class="text-sm text-cyan-200/70 mb-1">Remaining</p>
                    <p id="summary-remaining" class="text-3xl font-extrabold text-cyan-300">2200 <span class="text-base text-cyan-200/60">kcal</span></p>
                </div>
            </div>
        </div>

        <!-- NEW: Added welcome-animation class -->
        <div class="flex flex-col items-center mb-10 luxury-card p-8 welcome-animation" style="animation-delay: 0.2s">
            <div class="logo-watermark"></div> <div class="relative flex items-center justify-center mb-6">
                <svg id="progress-svg" width="220" height="220" viewBox="0 0 220 220" class="progress-ring">
                    <circle class="text-amber-900/30" stroke-width="14" stroke="currentColor" fill="transparent" r="100" cx="110" cy="110"/>
                    <circle id="progress-circle"
                        class="text-amber-500 transition-all duration-1000 ease-out"
                        stroke-width="14"
                        stroke-dasharray="0"
                        stroke-dashoffset="0"
                        stroke-linecap="round"
                        stroke="currentColor"
                        fill="transparent"
                        r="100"
                        cx="110"
                        cy="110"/>
                    <circle class="text-amber-900/10" stroke-width="1" stroke="currentColor" fill="transparent" r="85" cx="110" cy="110"/>
                </svg>
                <div class="absolute flex flex-col items-center">
                    <p id="kcal-consumed" class="text-5xl font-extrabold text-white">0</p>
                    <p class="text-base text-amber-200/60">of <span id="kcal-target">2200</span> kcal</p>
                    <p id="kcal-percentage" class="text-sm mt-2 font-semibold text-amber-400">0% Complete</p>
                </div>
            </div>
            <button id="scan-button" class="luxury-button text-lg pulse-glow">
                <span class="inline-block mr-2 text-xl align-middle">📸</span> AI Scan Food
            </button>
        </div>

        <h2 class="text-2xl font-bold text-white mb-6 font-serif welcome-animation" style="animation-delay: 0.3s">Macronutrients</h2>
        
        <!-- NEW: Added welcome-animation class -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10">
            <div id="protein-card" class="luxury-card p-5 welcome-animation" style="animation-delay: 0.4s">
                <div class="logo-watermark"></div> <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="text-lg font-semibold text-amber-300">Protein</h3>
                    <span class="text-xs luxury-tag">Muscle Fuel</span>
                </div>
                <div class="text-2xl font-bold text-white mb-2 relative z-10">
                    <span id="protein-value">0.0</span> <span class="text-base font-normal text-amber-200/60">g</span>
                </div>
                <div class="macro-progress mb-1 relative z-10" style="--progress-width: 0%; --progress-color: #D4AF37;"></div>
                <p class="text-xs text-amber-200/60 relative z-10">Goal: <span id="protein-target">150</span> g</p>
            </div>
            
            <div id="fat-card" class="luxury-card p-5 welcome-animation" style="animation-delay: 0.5s">
                <div class="logo-watermark"></div> <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="text-lg font-semibold text-amber-300">Fats</h3>
                    <span class="text-xs luxury-tag">Energy Source</span>
                </div>
                <div class="text-2xl font-bold text-white mb-2 relative z-10">
                    <span id="fat-value">0.0</span> <span class="text-base font-normal text-amber-200/60">g</span>
                </div>
                <div class="macro-progress mb-1 relative z-10" style="--progress-width: 0%; --progress-color: #F59E0B;"></div>
                <p class="text-xs text-amber-200/60 relative z-10">Goal: <span id="fat-target">60</span> g</p>
            </div>
            
            <div id="carbs-card" class="luxury-card p-5 welcome-animation" style="animation-delay: 0.6s">
                <div class="logo-watermark"></div> <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="text-lg font-semibold text-amber-300">Carbs</h3>
                    <span class="text-xs luxury-tag">Energy Boost</span>
                </div>
                <div class="text-2xl font-bold text-white mb-2 relative z-10">
                    <span id="carbs-value">0.0</span> <span class="text-base font-normal text-amber-200/60">g</span>
                </div>
                <div class="macro-progress mb-1 relative z-10" style="--progress-width: 0%; --progress-color: #EAB308;"></div>
                <p class="text-xs text-amber-200/60 relative z-10">Goal: <span id="carbs-target">250</span> g</p>
            </div>
        </div>

        <!-- NEW: Added welcome-animation class -->
        <div class="luxury-card p-6 welcome-animation" style="animation-delay: 0.7s">
            <div class="logo-watermark"></div> <div class="flex justify-between items-center mb-6 relative z-10">
                <h2 class="text-2xl font-bold text-white font-serif">Daily Food Log</h2>
                <span class="luxury-tag">Today</span>
            </div>
            <div id="log-history" class="space-y-4 pb-4 custom-scrollbar max-h-96 overflow-y-auto relative z-10">
                <div class="text-amber-200/50 p-8 text-center italic">
                    No food logged yet. Snap a picture or select an item!
                </div>
            </div>
        </div>

    </div>

    <div id="scan-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div id="scan-modal-content" class="luxury-modal p-8 w-full max-w-lg">
            <h3 class="text-3xl font-bold mb-6 gold-gradient font-serif text-center">AI Food Analysis</h3>
            
            <form id="scan-form" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="file-input-label bg-amber-900/40 border-amber-700/50 hover:bg-amber-800/40">
                            <input
                                type="file"
                                id="file-input-capture"
                                name="file-input-capture"
                                accept="image/*"
                                capture="environment" />
                            <span class="flex items-center justify-center text-amber-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                Capture Live Photo
                            </span>
                        </label>
                    </div>

                    <div>
                        <label class="file-input-label">
                            <input
                                type="file"
                                id="file-input-upload"
                                name="file-input-upload"
                                accept="image/*"
                            />
                            <span class="flex items-center justify-center text-amber-200/80">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15V8c0-.7-.6-1.2-1.2-1.2H16l-3.2-3.8c-.3-.3-.7-.5-1.2-.5h-3.2c-.4 0-.8.2-1.2.5L4.8 6.8H2.8c-.7 0-1.2.6-1.2 1.2v7c0 .7.6 1.2 1.2 1.2h18.4c.7 0 1.2-.6 1.2-1.2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                Upload Image
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="text-center text-amber-200/50 font-semibold italic py-2">--- OR Choose from Database ---</div>

                 <div>
                    <label class="block text-sm font-medium text-amber-200/80 mb-2">Select Common Food</label>
                    <select id="manual-food-select" class="glass-input-enhanced w-full">
                        <option value="">Select a common food item...</option>
                        <option value="Raw Gala Apple, large size">Gala Apple</option>
                        <option value="Medium Ripe Banana">Banana</option>
                        <option value="Raw Broccoli florets">Broccoli</option>
                        <option value="Whole Avocado">Avocado</option>
                        <option value="Sweet Potato, cooked">Sweet Potato</option>
                        <option value="Raw Spinach Leaves">Spinach</option>
                        <option value="Raw Chicken Breast, 100g">Chicken Breast (Raw)</option>
                        <option value="Cooked Brown Rice, 100g">Brown Rice (Cooked)</option>
                    </select>
                </div>

                <button type="submit" id="analyze-button" class="w-full luxury-button text-lg">
                    Run Multimodal AI Analysis
                </button>
            </form>

            <div id="loading-indicator" class="hidden text-center py-8">
                <div class="inline-flex items-center justify-center p-4 bg-amber-900/20 rounded-full mb-4">
                    <svg class="animate-spin h-8 w-8 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-amber-200/70">AI identifying image and fetching data...</p>
            </div>

            <div id="result-card" class="hidden mt-6 p-6 luxury-card">
                <h4 id="food-name" class="text-xl font-bold text-amber-300 mb-2"></h4>
                <p class="text-sm text-amber-200/70">AI Confidence: <span id="confidence" class="text-amber-400 font-semibold"></span>%</p>
                <p class="text-sm text-amber-200/60 border-b border-amber-800/30 pb-3 mb-3">Base Nutrients per 100g: <span id="base-kcal" class="text-amber-300"></span> kcal | <span id="base-fiber" class="text-amber-300"></span>g Fiber</p>
                
                <div class="flex flex-col sm:flex-row items-center justify-between mt-4 space-y-4 sm:space-y-0">
                    <div class="flex items-center">
                        <label for="portion-grams" class="text-sm font-medium text-amber-200/80 mr-3">Portion (g):</label>
                        <input type="number" id="portion-grams" value="100" min="1" class="glass-input w-20 text-center"/>
                    </div>
                    <div class="text-xl font-bold text-amber-300">
                        <span id="portion-kcal">0.0</span> kcal
                    </div>
                </div>
                
                <button id="log-button" class="w-full luxury-button mt-6">
                    Log 0.0 kcal to Diary
                </button>
                
                <div class="mt-4 p-3 bg-amber-900/10 rounded-xl border border-amber-800/20">
                    <p class="text-xs text-amber-200/60 italic">
                        <span class="font-semibold text-amber-300">Pro Tip:</span> <span id="suggested-use"></span>
                    </p>
                </div>
            </div>
            
            <button id="close-modal" class="mt-6 w-full py-3 glass-input text-amber-200/80 hover:text-amber-300 rounded-xl text-sm font-medium transition-colors">
                Close
            </button>
        </div>
    </div>
    
    <div id="goals-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="luxury-modal p-8 w-full max-w-lg">
            <h3 class="text-3xl font-bold mb-6 gold-gradient font-serif text-center">Set Your Daily Targets</h3>
            <form id="goals-form" class="space-y-5">
                <div>
                    <label for="target-kcal-input" class="block text-sm font-medium text-amber-200/80 mb-2">Calorie Target (kcal)</label>
                    <input type="number" id="target-kcal-input" min="1000" class="glass-input w-full"/>
                </div>
                <div>
                    <label for="target-protein-input" class="block text-sm font-medium text-amber-200/80 mb-2">Protein Goal (g)</label>
                    <input type="number" id="target-protein-input" min="0" class="glass-input w-full"/>
                </div>
                <div>
                    <label for="target-fat-input" class="block text-sm font-medium text-amber-200/80 mb-2">Fat Goal (g)</label>
                    <input type="number" id="target-fat-input" min="0" class="glass-input w-full"/>
                </div>
                <div>
                    <label for="target-carbs-input" class="block text-sm font-medium text-amber-200/80 mb-2">Carb Goal (g)</label>
                    <input type="number" id="target-carbs-input" min="0" class="glass-input w-full"/>
                </div>
                <button type="submit" class="w-full luxury-button text-lg mt-4">Save Goals</button>
            </form>
            <button id="close-goals-modal" class="mt-4 w-full py-3 glass-input text-amber-200/80 hover:text-amber-300 rounded-xl text-sm font-medium transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="luxury-modal p-8 w-full max-w-sm text-center">
            <h4 id="message-title" class="text-2xl font-bold text-amber-300 mb-4"></h4>
            <p id="message-content" class="text-amber-200/70 mb-6"></p>
            <button onclick="closeModal('message-modal')" class="w-full luxury-button">Got it!</button>
        </div>
    </div>

    <div id="journal-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="luxury-modal p-8 w-full max-w-lg">
            <h3 class="text-3xl font-bold mb-6 gold-gradient font-serif text-center">Gratitude Journal</h3>
            <textarea id="journal-input" class="glass-input w-full h-40" placeholder="What 3 things are you thankful for today?"></textarea>
            <button id="journal-save-btn" class="w-full luxury-button mt-6">Save Entry</button>
            <h4 class="text-xl font-bold text-amber-200 mt-8 mb-4">Previous Entry</h4>
            <div class="glass-input min-h-[80px]">
                <p id="journal-display" class="text-amber-200/60 italic">No previous entry found.</p>
            </div>
            <button onclick="closeModal('journal-modal')" class="mt-6 w-full py-3 glass-input text-amber-200/80 hover:text-amber-300 rounded-xl text-sm font-medium transition-colors">Close</button>
        </div>
    </div>

    <div id="mood-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="luxury-modal p-8 w-full max-w-lg text-center">
            <h3 class="text-3xl font-bold mb-6 gold-gradient font-serif">Track Your Mood</h3>
            <div id="mood-options" class="flex justify-around space-x-3 mb-8">
                <button data-mood="Happy" class="mood-option text-4xl">😊</button>
                <button data-mood="Calm" class="mood-option text-4xl">😌</button>
                <button data-mood="Neutral" class="mood-option text-4xl">😐</button>
                <button data-mood="Stressed" class="mood-option text-4xl">😥</button>
                <button data-mood="Tired" class="mood-option text-4xl">😴</button>
            </div>
            <div class="p-4 bg-amber-900/20 rounded-xl border border-amber-800/30">
                <p class="text-lg font-semibold text-amber-200">Today's Mood:</p>
                <p id="current-mood-display" class="text-xl font-bold text-amber-300 mt-2"><span id="mood-value">Not Logged</span></p>
            </div>
            <button onclick="closeModal('mood-modal')" class="mt-6 w-full py-3 glass-input text-amber-200/80 hover:text-amber-300 rounded-xl text-sm font-medium transition-colors">Close</button>
        </div>
    </div>

    <script>
        // --- Global Constants and Initial State ---
        const LOCAL_STORAGE_KEY = 'nutrisight_daily_log';
        const JOURNAL_KEY = 'nutrisight_journal';
        const MOOD_KEY = 'nutrisight_mood';
        const WATER_KEY = 'nutrisight_water';
        const USERNAME_KEY = 'nutrisight_username';
        const CIRCUMFERENCE = 2 * Math.PI * 100;
        
        const initialLog = {
            target_kcal: 2200,
            entries: [],
            date: new Date().toDateString(),
            targets: { protein: 150, fat: 60, carbs: 250 }
        };

        let currentAnalysis = null;
        // NOTE: The API key is stored here but should be handled securely in a real application.
        const apiKey = "AIzaSyAqjqStqnVctFq3BRs6pFEq9t9iNxlY-uY"; 

        // --- Local Storage Persistence (The Sticky State Logic) ---

        function getLog() {
            try {
                const storedLog = localStorage.getItem(LOCAL_STORAGE_KEY);
                const log = storedLog ? JSON.parse(storedLog) : initialLog;
                
                // If date is different, keep targets but reset entries
                if (log.date !== new Date().toDateString()) {
                    return {
                        ...initialLog,
                        targets: log.targets || initialLog.targets, // Keep user-set targets
                        target_kcal: log.targets?.kcal || log.target_kcal || 2200, // Re-use old total kcal target
                        date: new Date().toDateString()
                    };
                }
                // Ensure targets structure is correct on load
                if (!log.targets) {
                    log.targets = initialLog.targets;
                    log.targets.kcal = log.target_kcal;
                }
                return log;

            } catch (error) {
                console.error("Error retrieving log from localStorage. Resetting.", error);
                return initialLog;
            }
        }

        function saveLog(log) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(log));
            } catch (error) {
                console.error("Error saving log to localStorage.", error);
            }
        }

        // --- Data Calculation Utilities ---

        function calculateTotal(log, key) {
            return log.entries.reduce((sum, entry) => sum + (entry[key] || 0), 0);
        }
        
        /** Converts a File object to a Base64 string for API submission. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only data part
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Core AI Analysis Logic (Unified Input) ---
        
        /** * Runs AI analysis using either an image file or a manual text prompt. 
         * FIX: Corrected API JSON structure from 'config' to 'generationConfig' and 'systemInstruction'.
         */
        async function runAnalysis(input) {
            const isFile = input instanceof File;
            let imagePart = null;
            
            let textQuery = "Identify the food item and provide its nutritional breakdown per 100g. If it is a fruit, vegetable, or common whole food, also include a practical, common portion size (in grams) and its calculated nutritional breakdown for that suggested portion. Then, suggest one high-fiber, low-fat meal or usage tip based on a fitness diet. Respond in JSON format.";

            if (isFile) {
                const base64Image = await fileToBase64(input);
                imagePart = { inlineData: { mimeType: input.type, data: base64Image } };
            } else if (typeof input === 'string' && input.length > 0) {
                textQuery = `Analyze the nutritional data for the following specific food item per 100g: ${input}. ${textQuery}`;
            } else {
                throw new Error("Invalid input type provided to AI analysis.");
            }
            
            const systemPrompt = "You are a specialized food AI that identifies fresh produce and common ingredients, providing precise nutritional facts per 100g and one single, brief recipe or usage idea suitable for a user tracking fitness macros. Provide the raw data for the following categories: food_name (string, exact), confidence_score (number 90-100, if text input use 95), calories_kcal (number), protein_g (number), fat_g (number), carbohydrates_g (number), fiber_g (number), suggested_portion_g (number, provide 100 if a portion is complex to estimate), suggested_use (string). Ensure all numbers are provided as floating-point values for accurate calculation.";
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            const contents = [{ 
                parts: [
                    { text: textQuery },
                ].concat(imagePart ? [imagePart] : []) 
            }];

            const payload = {
                contents: contents,
                // FIX: System Instruction moved out of 'config'
                systemInstruction: { parts: [{ text: systemPrompt }] }, 
                // FIX: Configuration moved to 'generationConfig'
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "food_name": { "type": "STRING" },
                            "confidence_score": { "type": "NUMBER" },
                            "calories_kcal": { "type": "NUMBER" },
                            "protein_g": { "type": "NUMBER" },
                            "fat_g": { "type": "NUMBER" },
                            "carbohydrates_g": { "type": "NUMBER" },
                            "fiber_g": { "type": "NUMBER" }, 
                            "suggested_portion_g": { "type": "NUMBER" }, 
                            "suggested_use": { "type": "STRING" }
                        },
                        required: ["food_name", "confidence_score", "calories_kcal", "protein_g", "fat_g", "carbohydrates_g", "fiber_g", "suggested_portion_g", "suggested_use"]
                    }
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${errorData.error ? errorData.error.message : 'Unknown error'}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                const jsonText = result.candidates[0].content.parts[0].text;
                // Robust JSON parsing to handle possible code fences
                const cleanJsonMatch = jsonText.match(/```json\n([\s\S]*)\n```/);
                const cleanJson = cleanJsonMatch ? cleanJsonMatch[1] : jsonText.replace(/```json|```/g, '').trim(); 
                
                const parsedData = JSON.parse(cleanJson);
                
                return { ...parsedData, id: Date.now() };

            }
            
            throw new Error("AI response was empty or malformed.");
        }

        // --- UI Rendering Helpers ---

        function updateMacroProgress(containerId, total, target) {
            const percentage = target > 0 ? Math.min(100, (total / target) * 100) : 0;
            const progressBar = document.querySelector(`#${containerId} .macro-progress`);
            progressBar.style.setProperty('--progress-width', `${percentage}%`);
            
            document.getElementById(`${containerId.split('-')[0]}-value`).textContent = total.toFixed(1);
        }

        function renderDashboard(log) {
            const totalKcal = calculateTotal(log, 'kcal');
            const totalProtein = calculateTotal(log, 'protein');
            const totalFat = calculateTotal(log, 'fat');
            const totalCarbs = calculateTotal(log, 'carbs');
            const targetKcal = log.target_kcal || initialLog.target_kcal;
            const remainingKcal = Math.max(0, targetKcal - totalKcal);
            
            // 1. Update Summary Card
            document.getElementById('summary-target').innerHTML = `${targetKcal.toFixed(0)} <span class="text-base text-amber-200/60">kcal</span>`;
            document.getElementById('summary-remaining').innerHTML = `${remainingKcal.toFixed(0)} <span class="text-base text-cyan-200/60">kcal</span>`;
            document.getElementById('summary-remaining').className = `text-3xl font-extrabold ${remainingKcal > 100 ? 'text-cyan-300' : 'text-amber-400'}`;

            // 2. Kcal Ring Update
            const kcalPercentage = Math.min(100, (totalKcal / targetKcal) * 100);
            const offset = CIRCUMFERENCE - (kcalPercentage / 100) * CIRCUMFERENCE;
            
            const ring = document.getElementById('progress-circle');
            ring.setAttribute('stroke-dasharray', CIRCUMFERENCE);
            ring.setAttribute('stroke-dashoffset', offset);
            
            const colorClass = kcalPercentage > 95 ? 'text-red-500' : 'text-amber-500';
            ring.classList.remove('text-amber-500', 'text-red-500');
            ring.classList.add(colorClass.replace('text-', ''));
            
            document.getElementById('dashboard-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('kcal-consumed').textContent = totalKcal.toFixed(1);
            document.getElementById('kcal-target').textContent = targetKcal.toFixed(0);
            document.getElementById('kcal-percentage').textContent = `${kcalPercentage.toFixed(0)}% Complete`;
            document.getElementById('kcal-percentage').className = `text-sm mt-2 font-semibold ${colorClass}`;

            // 3. Macro Cards Update
            updateMacroProgress('protein-card', totalProtein, log.targets.protein);
            updateMacroProgress('fat-card', totalFat, log.targets.fat);
            updateMacroProgress('carbs-card', totalCarbs, log.targets.carbs);
            
            // Update target displays
            document.getElementById('protein-target').textContent = log.targets.protein;
            document.getElementById('fat-target').textContent = log.targets.fat;
            document.getElementById('carbs-target').textContent = log.targets.carbs;

            // 4. Log History Update
            renderLogHistory(log.entries);
            
            // 5. Water Tracker Update
            const currentWater = localStorage.getItem(WATER_KEY) ? parseInt(localStorage.getItem(WATER_KEY)) : 0;
            const waterTarget = 8;
            const waterPercentage = Math.min(100, (currentWater / waterTarget) * 100);
            document.getElementById('water-tracker-btn').textContent = `Water Tracker: ${waterPercentage.toFixed(0)}% (${currentWater} cups)`;
        }

        function renderLogHistory(entries) {
            const container = document.getElementById('log-history');
            container.innerHTML = ''; 

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="text-amber-200/50 p-8 text-center italic">
                        No food logged yet. Snap a picture or select an item!
                    </div>
                `;
                return;
            }

            entries.slice().reverse().forEach(entry => { 
                const entryElement = document.createElement('div');
                entryElement.className = "food-log-item relative z-10";
                entryElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-semibold text-lg text-amber-300">${entry.name}</p>
                            <p class="text-sm text-amber-200/60">
                                ${entry.grams}g | P:${entry.protein.toFixed(1)}g C:${entry.carbs.toFixed(1)}g F:${entry.fat.toFixed(1)}g | Fiber: ${entry.fiber ? entry.fiber.toFixed(1) : 0}g
                            </p>
                        </div>
                        <div class="text-xl font-bold text-white mr-4 flex items-center">
                            ${entry.kcal.toFixed(1)} <span class="text-xs text-amber-200/60 ml-1">kcal</span>
                        </div>
                        <button class="remove-entry-button text-amber-500 hover:text-amber-400 text-sm p-2 rounded-full bg-amber-900/20 transition-colors" data-id="${entry.id}" aria-label="Remove ${entry.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.72-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                container.appendChild(entryElement);
            });

            container.querySelectorAll('.remove-entry-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    const log = getLog();
                    log.entries = log.entries.filter(entry => entry.id !== id);
                    saveLog(log);
                    renderDashboard(log);
                });
            });
        }
        
        // --- Modal & Form Handlers (Standard) ---

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            if (modalId === 'scan-modal') {
                // Clear all input types
                document.getElementById('file-input-capture').value = '';
                document.getElementById('file-input-upload').value = '';
                document.getElementById('manual-food-select').value = '';
                document.getElementById('result-card').classList.add('hidden');
                document.getElementById('analyze-button').textContent = 'Run Multimodal AI Analysis';
                document.getElementById('analyze-button').disabled = false;
            }
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Core Logic for Modal Interaction ---

        async function handleAnalysis(event) {
            event.preventDefault();
            
            const manualSelect = document.getElementById('manual-food-select');
            // Check for file inputs only when a file change event hasn't already triggered the analysis
            
            let file = document.getElementById('file-input-capture').files[0] || document.getElementById('file-input-upload').files[0];
            const selectedFoodName = manualSelect.value;
            
            let inputSource;

            if (file) {
                inputSource = file; 
            } else if (selectedFoodName) {
                inputSource = selectedFoodName;
            } else {
                showSimpleMessage("Input Required", "Please take a photo, upload an image, or choose a food item from the list.", 'amber-400');
                return;
            }
            
            const loading = document.getElementById('loading-indicator');
            const analyzeBtn = document.getElementById('analyze-button');
            const resultCard = document.getElementById('result-card');
            
            resultCard.classList.add('hidden');
            analyzeBtn.disabled = true;
            loading.classList.remove('hidden');
            analyzeBtn.textContent = 'Processing with AI...';

            // Clear inputs right after capture/selection for clean slate
            document.getElementById('file-input-capture').value = '';
            document.getElementById('file-input-upload').value = '';
            document.getElementById('manual-food-select').value = '';

            try {
                const analysisData = await runAnalysis(inputSource);
                currentAnalysis = analysisData;

                // Populate Result Card
                document.getElementById('food-name').textContent = analysisData.food_name;
                document.getElementById('confidence').textContent = analysisData.confidence_score.toFixed(1);
                document.getElementById('base-kcal').textContent = analysisData.calories_kcal.toFixed(1);
                document.getElementById('base-fiber').textContent = analysisData.fiber_g.toFixed(1);
                document.getElementById('suggested-use').textContent = analysisData.suggested_use;
                
                // Set portion to suggested portion
                const suggestedPortion = analysisData.suggested_portion_g || 100;
                document.getElementById('portion-grams').value = suggestedPortion.toFixed(0);
                updatePortionKcal(suggestedPortion);

                resultCard.classList.remove('hidden');
                analyzeBtn.textContent = 'Analysis Complete!';

            } catch (error) {
                console.error("AI Analysis Error:", error);
                resultCard.classList.remove('hidden');
                document.getElementById('food-name').textContent = 'AI Error';
                document.getElementById('confidence').textContent = '0.0';
                document.getElementById('base-kcal').textContent = '0.0';
                document.getElementById('base-fiber').textContent = '0.0'; 
                document.getElementById('suggested-use').textContent = error.message || 'Could not process the request. The API may have returned an error. Try again.';
                analyzeBtn.textContent = 'Retry Analysis';
                analyzeBtn.disabled = false;

            } finally {
                loading.classList.add('hidden');
            }
        }
        
        // --- Goal Setting Logic ---

        function handleGoalSetting(event) {
            event.preventDefault();
            
            const kcal = parseInt(document.getElementById('target-kcal-input').value) || 2200;
            const protein = parseInt(document.getElementById('target-protein-input').value) || 150;
            const fat = parseInt(document.getElementById('target-fat-input').value) || 60;
            const carbs = parseInt(document.getElementById('target-carbs-input').value) || 250;
            
            if (kcal < 1000) {
                console.warn("Calorie target must be at least 1000.");
                return;
            }

            const log = getLog();
            log.target_kcal = kcal;
            log.targets = { protein, fat, carbs, kcal };
            
            saveLog(log);
            renderDashboard(log);
            closeModal('goals-modal');
        }
        
        // --- Portion Calculation Logic ---

        function updatePortionKcal(grams) {
            if (!currentAnalysis) return;

            const baseKcalPer100g = currentAnalysis.calories_kcal;
            const portionKcal = (baseKcalPer100g / 100) * grams;
            
            document.getElementById('portion-kcal').textContent = portionKcal.toFixed(1);
            document.getElementById('log-button').textContent = `Log ${portionKcal.toFixed(1)} kcal to Diary`;
        }
        
        // --- Log Entry Logic ---

        function handleLogEntry() {
            if (!currentAnalysis) return;

            const portionGrams = parseFloat(document.getElementById('portion-grams').value) || 0;
            if (portionGrams <= 0) {
                console.warn("Portion size must be greater than 0.");
                return;
            }

            const scaleFactor = portionGrams / 100;
            
            const newEntry = {
                id: currentAnalysis.id,
                name: currentAnalysis.food_name,
                grams: portionGrams.toFixed(0),
                kcal: (currentAnalysis.calories_kcal * scaleFactor),
                protein: (currentAnalysis.protein_g * scaleFactor),
                fat: (currentAnalysis.fat_g * scaleFactor),
                carbs: (currentAnalysis.carbohydrates_g * scaleFactor),
                fiber: (currentAnalysis.fiber_g * scaleFactor) || 0, 
            };

            const log = getLog();
            log.entries.push(newEntry);
            saveLog(log);
            renderDashboard(log);
            closeModal('scan-modal');
        }
        
        // --- Sidebar & Utility Functions ---

        function showSimpleMessage(title, content, color='amber-400') {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            document.getElementById('message-title').className = `text-2xl font-bold mb-4 text-${color}`;
            openModal('message-modal');
        }
        
        function toggleSection(button) {
            const targetId = button.getAttribute('data-target');
            const content = document.getElementById(targetId);
            const arrow = button.querySelector('.sidebar-arrow');

            document.querySelectorAll('.sidebar-content').forEach(c => {
                if (c.id !== targetId && c.style.maxHeight !== '0px') {
                    c.style.maxHeight = '0px';
                    document.querySelector(`[data-target="${c.id}"] .sidebar-arrow`).classList.remove('rotated');
                }
            });

            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.classList.add('rotated');
            } else {
                content.style.maxHeight = '0px';
                arrow.classList.remove('rotated');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar.classList.contains('mobile-hidden')) {
                sidebar.classList.remove('mobile-hidden');
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('mobile-open');
                sidebar.classList.add('mobile-hidden');
                overlay.classList.remove('active');
            }
        }

        // --- Mental/Wellness Functions (Simplified for brevity, maintained in structure) ---
        
        function startMeditation() {
            let seconds = 300; // 5 minutes
            showSimpleMessage("Meditation Started", `Focus on your breath for 5 minutes. Timer is running in the background.`);
            const timer = setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(timer);
                    showSimpleMessage("Meditation Complete!", "You finished your 5-minute session. Great job taking care of your mind!", 'blue-400');
                }
            }, 1000);
        }

        function showAffirmation() {
            const affirmations = ["I am strong, capable, and worthy of all good things.", "My potential is limitless. I choose to be happy today.", "I am in control of my choices and my feelings."];
            const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
            showSimpleMessage("Daily Affirmation", affirmation, 'pink-400');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('journal-open-btn').addEventListener('click', () => {
                const entry = localStorage.getItem(JOURNAL_KEY) || "No entry saved for today.";
                document.getElementById('journal-display').textContent = entry;
                document.getElementById('journal-input').value = entry === "No entry saved for today." ? "" : entry;
                openModal('journal-modal');
            });

            document.getElementById('journal-save-btn').addEventListener('click', () => {
                const entry = document.getElementById('journal-input').value;
                if (entry.trim()) {
                    localStorage.setItem(JOURNAL_KEY, entry.trim());
                    showSimpleMessage("Journal Saved", "Your gratitude entry has been successfully logged!", 'amber-400');
                    closeModal('journal-modal');
                } else {
                    showSimpleMessage("Empty Entry", "Please write something before saving.", 'amber-400');
                }
            });
        });

        function startWaterTracker() {
            const currentWater = localStorage.getItem(WATER_KEY) ? parseInt(localStorage.getItem(WATER_KEY)) : 0;
            const newWater = currentWater + 1;
            localStorage.setItem(WATER_KEY, newWater);
            renderDashboard(getLog());
            if (newWater >= 8) {
                showSimpleMessage("Hydration Goal Met!", `You've logged ${newWater} cups. Stay refreshed!`, 'blue-400');
            } else {
                showSimpleMessage("Water Logged", `Logged 1 cup. Total: ${newWater} cups. Keep going!`, 'blue-400');
            }
        }

        function planMeal() { showSimpleMessage("AI Meal Planning", "Analyzing goals to create a personalized meal plan.", 'amber-400'); }
        function generateWorkout() { showSimpleMessage("Daily Workout", "30-Min Full Body: Pushups, Squats, Lunges, Plank. Repeat 3x.", 'amber-400'); }
        function postureAlert() { showSimpleMessage("Posture Check", "Straighten your back, roll your shoulders back, and stretch.", 'pink-400'); }
        function startMoodMusic() { showSimpleMessage("Mood Music", "Playing relaxing, focus-enhancing ambient tracks.", 'blue-400'); }
        function connectAndShare() { showSimpleMessage("Connect & Share", "Share a positive note with yourself instead!", 'amber-400'); }
        function scheduleDay() { showSimpleMessage("Sample Daily Schedule", "Log meals, water, and mood checkpoints throughout the day.", 'blue-400'); }
        function showReminders() { showSimpleMessage("Health Reminders", "Reminders set for Water, Posture, and Journaling.", 'amber-400'); }
        function runChallenge() { showSimpleMessage("2-Day Challenge", "Log all meals, hit 8 cups water, and write 2 gratitude entries.", 'amber-400'); }

        // Mood Tracker Logic (Simplified)
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('mood-tracker-btn').addEventListener('click', () => {
                const mood = localStorage.getItem(MOOD_KEY) || "Not Logged";
                document.getElementById('mood-value').textContent = mood;
                document.querySelectorAll('.mood-option').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.mood === mood) {
                        btn.classList.add('active');
                    }
                });
                openModal('mood-modal');
            });
        });

        document.querySelectorAll('.mood-option').forEach(button => {
            button.addEventListener('click', (e) => {
                const mood = e.currentTarget.dataset.mood;
                document.querySelectorAll('.mood-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.currentTarget.classList.add('active');
                localStorage.setItem(MOOD_KEY, mood);
                document.getElementById('mood-value').textContent = mood;
                showSimpleMessage("Mood Logged", `You've logged your mood as ${mood}.`, 'pink-400');
                closeModal('mood-modal');
            });
        });


        // --- Initialization (Main Function) ---

        window.onload = function() {
            // NEW: Check for username in localStorage or prompt for it
            let username = localStorage.getItem(USERNAME_KEY);
            if (!username) {
                username = prompt("Welcome to eatsence.ai! What's your name?") || "User";
                localStorage.setItem(USERNAME_KEY, username);
            }
            document.getElementById('username-display').textContent = username;

            // Event Listeners for Modals
            document.getElementById('scan-button').addEventListener('click', () => openModal('scan-modal'));
            document.getElementById('close-modal').addEventListener('click', () => closeModal('scan-modal'));
            document.getElementById('goals-button').addEventListener('click', () => {
                const log = getLog();
                document.getElementById('target-kcal-input').value = log.target_kcal;
                document.getElementById('target-protein-input').value = log.targets.protein;
                document.getElementById('target-fat-input').value = log.targets.fat;
                document.getElementById('target-carbs-input').value = log.targets.carbs;
                openModal('goals-modal');
            });
            document.getElementById('close-goals-modal').addEventListener('click', () => closeModal('goals-modal'));

            // New: Outside click handler for scan-modal
            document.getElementById('scan-modal').addEventListener('click', function(e) {
                const modalContent = document.getElementById('scan-modal-content');
                if (e.target === this && !modalContent.contains(e.target)) {
                    closeModal('scan-modal');
                }
            });

            // New: Mobile sidebar toggle button handler
            document.getElementById('mobile-sidebar-toggle').addEventListener('click', toggleSidebar);

            // **NEW LOGIC:** Trigger analysis when a file is selected using either input
            document.getElementById('file-input-capture').addEventListener('change', () => {
                 // Trigger the form submit logic when a file is selected
                document.getElementById('analyze-button').click(); 
            });
            document.getElementById('file-input-upload').addEventListener('change', () => {
                 document.getElementById('analyze-button').click();
            });

            // Form Submissions
            document.getElementById('scan-form').addEventListener('submit', handleAnalysis);
            document.getElementById('goals-form').addEventListener('submit', handleGoalSetting);
            document.getElementById('log-button').addEventListener('click', handleLogEntry);
            
            // Portion Input Listener
            document.getElementById('portion-grams').addEventListener('input', (e) => {
                updatePortionKcal(parseFloat(e.target.value) || 0);
            });

            // Load and render initial dashboard state
            const initialLogState = getLog();
            renderDashboard(initialLogState);
        };
    </script>
</body>
</html>
